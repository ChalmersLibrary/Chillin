@model Chalmers.ILL.Models.PartialPage.ChalmersILLActionReceiveBookModel

<div class="action-header">Ta emot bok</div>

@using System.Globalization;

<textarea id="mail-message" hidden>@Model.BookAvailableMailTemplate</textarea>

<div id="delivery-to-circulation" class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label for="providerInformation">Leverantörsinformation</label><br />
            <textarea class="form-control" cols="80" rows="5" id="providerInformation" name="providerInformation" onchange="providerInfoHasBeenEdited();">@Model.OrderItem.ProviderInformation</textarea>
        </div>
        <div class="form-group">
            <label for="bookId">Bokens streckkod/identifikator</label>
            <input type="text" class="form-control" id="bookId" name="bookId" value="@Model.OrderItem.BookId">
        </div>
        <div class="form-group">
            <label for="dueDate">Återlämningsdatum</label>
            <div class="input-group date datetimepicker">
                <input type="text" class="form-control" id="dueDate" name="dueDate" value="@Model.OrderItem.DueDate.ToString("yyyy-MM-dd HH:mm", CultureInfo.CurrentCulture)">
                <span class="input-group-addon">
                    <span class="glyphicon glyphicon-calendar"></span>
                </span>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-12">
                <div class="alert alert-success" role="alert">Automatiskt mailutskick kommer att levereras till <span id="patron-email" class="content-editable" contenteditable>@Model.OrderItem.PatronEmail</span> <span class="glyphicon glyphicon-pencil"></span></div>
                <button class="btn btn-success" onclick="deliver()">Ta emot</button>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div id="printDiv" class="print">
            <h3 style="float:right" class="dueDatePlaceHolder"></h3><br />
            <div style="font-size:1.5em">Infodisk, tag ut och läs!</div>
            <strong style="font-size:1.5em">@Model.OrderItem.SierraInfo.last_name @Model.OrderItem.SierraInfo.first_name</strong><br />
            <br />
            <br />
            <p style="font-size:1.4em">
                OBS! Innan du lånar ut boken<br />
                1.	Kolla låntagaren i Sierra.<br />
                2.	Ta ut detta papper ur boken.<br />
                3.	Ge boken till låntagaren.<br />
                4.	Lägg detta papper i lila lådan.<br />
            </p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <div style="float:right">
                @{
                    string barcodeurl = "http://barcode.tec-it.com/barcode.ashx?translate-esc=off&data=" + Model.OrderItem.OrderId + "w&code=Code128&unit=Fit&dpi=96&imagetype=Gif&rotation=0&color=000000&bgcolor=FFFFFF&qunit=Mm&quiet=0";
                    //string barcodeurl = "http://barcodes4.me/barcode/c39/" + @Model.OrderItem.OrderId + ".png";
                    <img width="300" src=@barcodeurl /><br />
                }
            </div>
            <div class="pb"></div>
            <h3 class="dueDatePlaceHolder"></h3>
            <br />
            <br />
            <br />
            <br />
            <br />
            <br />
            <br />
            <br />
            <br />
        </div>
        <div class="form-group">
            <label for="log-message">Skriv till logg (valfritt)</label>
            <textarea class="form-control" rows="6" id="log-message" name="log-message"></textarea>
        </div>
    </div>
</div>

<script type="text/javascript">
    var hasProviderInfoBeenEdited = false;

    $(function () {
        $(".datetimepicker").datetimepicker({
            locale: "sv"
        });
    });

    function deliver() {
        if (hasProviderInfoBeenEdited || confirm("Du har inte ändrat leverantörsdata. Är du säker på att du vill fortsätta?")) {
            $('#container #printDiv').insertAfter('#container');
            var dueDate = moment($('#dueDate').val()).format("YYYY-MM-DD");
            $('.dueDatePlaceHolder').html(dueDate);
            window.print();
            var r = window.confirm("Skrevs bokslippen ut korrekt?");
            if (r == true) {
                setOrderItemDeliveryReceived(@Model.OrderItem.NodeId, $('#bookId').val(), $('#dueDate').val(), $('#providerInformation').val(),
                {
                    nodeId: @Model.OrderItem.NodeId,
                    recipientEmail: $("#patron-email").text().toString().trim(),
                    recipientName: "@Model.OrderItem.PatronName",
                    message: $("#mail-message").val(),
                    newStatusId: @Model.AvailableStatuses.First(x => x.Value.Contains("Infodisk")).Id,
                    newCancellationReasonId: -1,
                    newPurchasedMaterialId: -1,
                    newFollowUpDate: $('#dueDate').val(),
                }, $("#log-message").val(), false);
                $("#printDiv").remove();
            } else {
                alert("Leveransfunktionen kommer laddas om, försök därefter igen.");
                $("#printDiv").remove();
                loadReceiveBookAction(@Model.OrderItem.NodeId);
            }
        }
    }

    function providerInfoHasBeenEdited() {
        hasProviderInfoBeenEdited = true;
    }
</script>