@inherits Umbraco.Web.Mvc.UmbracoViewPage<Chalmers.ILL.Models.Page.ChalmersILLDiskPageModel>
@using umbraco.cms.businesslogic.member;
@using System.Web.Security;
@using Examine;
@using Chalmers.ILL.Controllers.SurfaceControllers;
@using Chalmers.ILL.Extensions;
@using Umbraco.Core.Logging;
@using System.Globalization;

@{
    Layout = null;
}
<!doctype html>
<html>
    <head>
        <title>Chalmers fjärrlån &amp; bokförvärv</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="/css/chalmers.ill.main.css">
        <script src="/bower_components/jquery/dist/jquery.min.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/disk/">
                ChILLIn Cirkulation
                </a>
            </div>
        </nav>

        <div class="row" style="margin-top: 28px;">
            <div class="col-sm-4 centered">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">Sök</h3>
                    </div>
                    <div class="panel-body">
                        <form method="get">
                            <div class="form-group">
                                <input id="DiskSearch" name="query" class="form-control" type="text"/>
                            </div>
                            <button type="submit" class="btn btn-primary">Sök</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        @{
            int loggedInMember = Model.CurrentMemberId;
            if(!String.IsNullOrEmpty(Request.QueryString["query"]))
            {
                // Connect to an Examine Search Provider
                var searcher = ExamineManager.Instance.SearchProviderCollection["ChalmersILLOrderItemsSearcher"];

                // Specify Search Criteria
                var searchCriteria = searcher.CreateSearchCriteria(Examine.SearchCriteria.BooleanOperation.Or);

                // Specify the query
                var query = searchCriteria.RawQuery(Request.Params["query"]);

                // Loop trough results
                var results = searcher.Search(query);

                foreach(var item in results) {
                    @RenderItems(loggedInMember, item.Id, DateTime.ParseExact(item.Fields.GetValueString("FollowUpDate"), "yyyyMMddHHmmssfff", CultureInfo.InvariantCulture, DateTimeStyles.None),
                        item.Fields.GetValueString("PatronName"), item.Fields.GetValueString("DeliveryLibrary"), item.Fields.GetValueString("Status"),
                        item.Fields.GetValueString("Type"), item.Fields.GetValueString("Reference"),
                        item.Fields.GetValueString("DueDate"), item.Fields.GetValueString("BookId"), item.Fields.GetValueString("ReadOnlyAtLibrary"),
                        item.Fields.GetValueString("PatronEmail"), item.Fields.GetValueString("PatronCardNo"));
                }
            }
        }

        <script type="text/javascript">
            $(document).ready(function () { $("#DiskSearch").focus(); });
        </script>

        <!-- Load Boostrap at the end to first get all content loaded -->
        <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

        <!-- SignalR related scripts -->
        <script src="/bower_components/signalr/jquery.signalR.min.js" type="text/javascript"></script>
        <script src="/signalr/hubs" type="text/javascript"></script>

        <!-- Custom Javascript for this app -->
        <script src="/scripts/chalmers.ill.js?r=@DateTime.Now.Ticks" type="text/javascript"></script>

        <script type="text/javascript">
            function receive(id) {
                lockScreen();
                $.post("/umbraco/surface/OrderItemReceiveBookSurface/SetOrderItemDeliveryReceivedAtBranch", {
                    nodeId: id
                }, function (json) {
                    if (json.Success) {
                        $("#statusActions").html("Boken mottagen.");
                    }
                    else {
                        alert(json.Message);
                    }
                    unlockScreen();
                }).fail(function (jqxhr, textStatus, error) {
                    alert("Error: " + textStatus + " " + error);
                    unlockScreen();
                });
            }
        </script>
    </body>

</html>

@helper ParseStatusPrevalue(string prevalue)
{
    @prevalue.Split(':').Last()
}

@helper RenderItems(int memberId, object Id, DateTime date, object patronName, object library, object status, object type, object reference, object dueDate, object bookId, object readOnlyAtLibrary, string patronEmail, object patronCardNumber)
{
    bool localLoan = false;
    if(@readOnlyAtLibrary.ToString() == "1")
    {
        localLoan = true;
    }
    <div class="row">
        <div class="panel panel-default">
            <div class="panel-heading">
                <div class="row">
                    <div class="col-sm-10">@patronName (@patronCardNumber | @patronEmail)</div>
                    <div class="col-sm-2 text-right">Återlämning: @dueDate.ToString().Substring(0,8)</div>
                </div>
            </div>
            <div class="panel-body">
                @if (localLoan)
                {
                    <div class="alert alert-danger" role="alert">OBS! Endast läsesalslån!</div>
                }
            Identifikator: <strong>@bookId</strong><br />
                Referens: @reference
            </div>
            <div class="panel-footer">
                <div class="row">
                    <div class="col-sm-10">@ParseStatusPrevalue(status.ToString())</div>
                    <div id="statusActions" class="col-sm-2 text-right">
                        @if(ParseStatusPrevalue(status.ToString()).ToString() == "Transport") {
                            <button type="submit" class="btn btn-success" onclick="receive(@Id)">Ta emot</button>
                        }
                    </div>
                </div>
            </div>
        </div>
        @*<div class="col-sm-2" data-column="patronName">@patronName</div>
        <div class="col-sm-1" data-column="status">@ParseStatusPrevalue(status.ToString())</div>
        <div class="col-sm-1" data-column="dueDate">@dueDate</div>
        <div class="col-sm-8" data-column="reference">@reference</div>*@
    </div>
}
